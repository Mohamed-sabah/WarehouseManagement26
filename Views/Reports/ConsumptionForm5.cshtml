@model WarehouseManagement.Models.ViewModels.ConsumptionForm5ViewModel
@{
    ViewData["Title"] = "نموذج 5 - سجل الصرف";
    ViewData["Subtitle"] = "استمارة صرف المواد الرسمية";
}

<div class="page-header d-flex justify-content-between align-items-center mb-4 no-print">
    <div>
        <h1><i class="fas fa-file-invoice text-info me-2"></i>نموذج 5 - سجل الصرف</h1>
        <small class="text-muted">استمارة صرف المواد والاستهلاك</small>
    </div>
    <div>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-right me-1"></i>العودة
        </a>
        <button onclick="window.print()" class="btn btn-info">
            <i class="fas fa-print me-1"></i>طباعة
        </button>
        <a asp-action="ExportForm5" asp-route-year="@Model.Year" asp-route-month="@Model.Month" class="btn btn-success">
            <i class="fas fa-file-excel me-1"></i>تصدير Excel
        </a>
    </div>
</div>

<!-- Form Header - Official Government Style -->
<div class="card mb-4">
    <div class="card-body text-center">
        <div class="row mb-3">
            <div class="col-4 text-start">
                <p class="mb-1"><strong>جمهورية العراق</strong></p>
                <p class="mb-1">@Model.InstitutionName</p>
                <p class="mb-0">قسم المخازن</p>
            </div>
            <div class="col-4">
                <h3 class="mb-2">نموذج رقم (5)</h3>
                <h4>سجل صرف المواد</h4>
            </div>
            <div class="col-4 text-end">
                @{
                    string[] arabicMonths = { "كانون الثاني", "شباط", "آذار", "نيسان", "أيار", "حزيران",
                                              "تموز", "آب", "أيلول", "تشرين الأول", "تشرين الثاني", "كانون الأول" };
                }
                <p class="mb-1">الشهر: <strong>@arabicMonths[Model.Month - 1] @Model.Year</strong></p>
                <p class="mb-1">رقم السجل: @Model.FormNumber</p>
                <p class="mb-0">تاريخ الطباعة: @DateTime.Now.ToString("yyyy/MM/dd")</p>
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-md-4">
                <p class="mb-0"><strong>اسم المخزن:</strong> @Model.WarehouseName</p>
            </div>
            <div class="col-md-4">
                <p class="mb-0"><strong>أمين المخزن:</strong> @Model.WarehouseKeeper</p>
            </div>
            <div class="col-md-4">
                <p class="mb-0"><strong>الجهة المستلمة:</strong> @(Model.DepartmentId.HasValue ? Model.DepartmentName : "جميع الجهات")</p>
            </div>
        </div>
    </div>
</div>

<!-- Filter Options -->
<div class="card mb-4 no-print">
    <div class="card-body">
        <form asp-action="ConsumptionForm5" method="get" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">السنة</label>
                <select name="year" class="form-select">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <option value="@y" selected="@(y == Model.Year)">@y</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">الشهر</label>
                <select name="month" class="form-select">
                    @for (int m = 1; m <= 12; m++)
                    {
                        <option value="@m" selected="@(m == Model.Month)">@arabicMonths[m - 1]</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">الجهة المستلمة</label>
                <select name="departmentId" class="form-select">
                    <option value="">-- جميع الجهات --</option>
                    @if (ViewBag.Departments != null)
                    {
                        @foreach (var dept in ViewBag.Departments as IEnumerable<WarehouseManagement.Models.Department>)
                        {
                            <option value="@dept.Id" selected="@(dept.Id == Model.DepartmentId)">@dept.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">الفئة</label>
                <select name="categoryId" class="form-select">
                    <option value="">-- جميع الفئات --</option>
                    @if (ViewBag.Categories != null)
                    {
                        @foreach (var cat in ViewBag.Categories as IEnumerable<WarehouseManagement.Models.Category>)
                        {
                            <option value="@cat.Id" selected="@(cat.Id == Model.CategoryId)">@cat.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-sync me-1"></i>تحديث
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-info text-white text-center p-3">
            <h3 class="mb-0">@Model.TotalTransactions</h3>
            <small>عدد عمليات الصرف</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white text-center p-3">
            <h3 class="mb-0">@Model.TotalItems</h3>
            <small>عدد الأصناف</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white text-center p-3">
            <h3 class="mb-0">@Model.TotalQuantity.ToString("N0")</h3>
            <small>إجمالي الكميات</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white text-center p-3">
            <h3 class="mb-0">@Model.TotalValue.ToString("N0")</h3>
            <small>إجمالي القيمة</small>
        </div>
    </div>
</div>

<!-- Main Consumption Table -->
<div class="card">
    <div class="card-header bg-info text-white">
        <i class="fas fa-table me-2"></i>سجل الصرف التفصيلي - @arabicMonths[Model.Month - 1] @Model.Year
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-sm mb-0" style="font-size: 12px;">
                <thead class="table-dark">
                    <tr>
                        <th class="text-center">ت</th>
                        <th class="text-center">التاريخ</th>
                        <th class="text-center">رقم الإذن</th>
                        <th>رمز المادة</th>
                        <th>اسم المادة</th>
                        <th>الوحدة</th>
                        <th class="text-center">الكمية</th>
                        <th class="text-center">سعر الوحدة</th>
                        <th class="text-center">القيمة</th>
                        <th>الجهة المستلمة</th>
                        <th>المستلم</th>
                        <th>ملاحظات</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items != null && Model.Items.Any())
                    {
                        int index = 1;
                        string currentDate = "";
                        
                        @foreach (var item in Model.Items.OrderBy(i => i.IssueDate).ThenBy(i => i.IssueNumber))
                        {
                            var itemDate = item.IssueDate.ToString("yyyy/MM/dd");
                            var showDate = itemDate != currentDate;
                            currentDate = itemDate;
                            
                            <tr>
                                <td class="text-center">@(index++)</td>
                                <td class="text-center">
                                    @if (showDate)
                                    {
                                        @itemDate
                                    }
                                </td>
                                <td class="text-center"><code>@item.IssueNumber</code></td>
                                <td><code>@item.MaterialCode</code></td>
                                <td>@item.MaterialName</td>
                                <td class="text-center">@item.Unit</td>
                                <td class="text-center">@item.Quantity.ToString("N2")</td>
                                <td class="text-center">@item.UnitPrice.ToString("N2")</td>
                                <td class="text-center">@item.TotalValue.ToString("N0")</td>
                                <td>@item.DepartmentName</td>
                                <td>@item.ReceivedBy</td>
                                <td>@item.Notes</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="12" class="text-center py-4">
                                <i class="fas fa-info-circle text-info me-2"></i>
                                لا توجد عمليات صرف في الفترة المحددة
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-secondary fw-bold">
                    <tr>
                        <td colspan="6" class="text-start">المجموع الكلي</td>
                        <td class="text-center">@Model.TotalQuantity.ToString("N2")</td>
                        <td class="text-center">-</td>
                        <td class="text-center">@Model.TotalValue.ToString("N0")</td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Summary by Department -->
@if (Model.Items != null && Model.Items.Any())
{
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-building me-2"></i>ملخص حسب الجهة المستلمة
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>الجهة</th>
                                <th class="text-center">عدد العمليات</th>
                                <th class="text-center">الكمية</th>
                                <th class="text-center">القيمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dept in Model.Items.GroupBy(i => i.DepartmentName).OrderByDescending(g => g.Sum(i => i.TotalValue)))
                            {
                                <tr>
                                    <td>@dept.Key</td>
                                    <td class="text-center">@dept.Count()</td>
                                    <td class="text-center">@dept.Sum(i => i.Quantity).ToString("N2")</td>
                                    <td class="text-center">@dept.Sum(i => i.TotalValue).ToString("N0")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-boxes me-2"></i>ملخص حسب الفئة
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>الفئة</th>
                                <th class="text-center">عدد الأصناف</th>
                                <th class="text-center">الكمية</th>
                                <th class="text-center">القيمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cat in Model.Items.GroupBy(i => i.CategoryName).OrderByDescending(g => g.Sum(i => i.TotalValue)))
                            {
                                <tr>
                                    <td>@cat.Key</td>
                                    <td class="text-center">@cat.Select(i => i.MaterialCode).Distinct().Count()</td>
                                    <td class="text-center">@cat.Sum(i => i.Quantity).ToString("N2")</td>
                                    <td class="text-center">@cat.Sum(i => i.TotalValue).ToString("N0")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

<!-- Top Consumed Materials -->
@if (Model.Items != null && Model.Items.Any())
{
    <div class="card mt-4">
        <div class="card-header">
            <i class="fas fa-chart-bar me-2"></i>أكثر المواد استهلاكاً
        </div>
        <div class="card-body">
            <div class="row">
                @foreach (var material in Model.Items.GroupBy(i => new { i.MaterialCode, i.MaterialName, i.Unit })
                                                     .OrderByDescending(g => g.Sum(i => i.TotalValue))
                                                     .Take(10))
                {
                    var totalQty = material.Sum(i => i.Quantity);
                    var totalVal = material.Sum(i => i.TotalValue);
                    var percentage = Model.TotalValue > 0 ? (totalVal / Model.TotalValue * 100) : 0;
                    
                    <div class="col-md-6 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span><code>@material.Key.MaterialCode</code> @material.Key.MaterialName</span>
                            <span class="badge bg-primary">@totalVal.ToString("N0")</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: @percentage%">
                                @totalQty.ToString("N0") @material.Key.Unit (@percentage.ToString("F1")%)
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

<!-- Signatures Section -->
<div class="card mt-4">
    <div class="card-body">
        <div class="row text-center mt-3">
            <div class="col-md-4">
                <p class="mb-4">أمين المخزن</p>
                <p class="border-top pt-2">@Model.WarehouseKeeper</p>
                <p class="text-muted small">التوقيع والتاريخ</p>
            </div>
            <div class="col-md-4">
                <p class="mb-4">مدقق الحسابات</p>
                <p class="border-top pt-2">________________</p>
                <p class="text-muted small">التوقيع والتاريخ</p>
            </div>
            <div class="col-md-4">
                <p class="mb-4">مدير القسم</p>
                <p class="border-top pt-2">________________</p>
                <p class="text-muted small">التوقيع والتاريخ</p>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        @@media print {
            .no-print { display: none !important; }
            .card { border: 1px solid #000 !important; }
            body { font-size: 10px; }
            table { font-size: 9px; }
            .page-header { display: none; }
        }
        @@page {
            size: A4 landscape;
            margin: 1cm;
        }
    </style>
}
