@model MaterialStock
@{
    ViewData["Title"] = $"تفاصيل المخزون - {Model.Material.Name}";
    ViewData["Subtitle"] = Model.Location.Name;
}

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-boxes me-2"></i>@Model.Material.Name</h1>
        <small class="text-muted">@Model.Location.Name - <code>@Model.Material.Code</code></small>
    </div>
    <div class="btn-group">
        <a asp-action="Adjust" asp-route-id="@Model.Id" class="btn btn-warning">
            <i class="fas fa-edit me-1"></i>تعديل الكمية
        </a>
        <a asp-controller="Transfers" asp-action="Create" 
           asp-route-materialId="@Model.MaterialId" 
           asp-route-fromLocationId="@Model.LocationId" 
           class="btn btn-primary">
            <i class="fas fa-exchange-alt me-1"></i>نقل
        </a>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-right me-1"></i>العودة
        </a>
    </div>
</div>

<!-- Status Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card @(Model.Quantity <= Model.Material.MinimumStock ? "warning" : "success")">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-0">@Model.Quantity</h3>
                    <small>@Model.Material.Unit</small>
                </div>
                <i class="fas fa-cubes fa-2x opacity-50"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-0">@Model.CurrentValue.ToString("N0")</h3>
                    <small>القيمة (د.ع)</small>
                </div>
                <i class="fas fa-coins fa-2x opacity-50"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card @(Model.IsExpired ? "warning" : Model.IsExpiringSoon ? "warning" : "primary")">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    @if (Model.ExpiryDate.HasValue)
                    {
                        <h5 class="mb-0">@Model.ExpiryDate.Value.ToString("yyyy/MM/dd")</h5>
                        <small>تاريخ الانتهاء</small>
                    }
                    else
                    {
                        <h5 class="mb-0">غير محدد</h5>
                        <small>تاريخ الانتهاء</small>
                    }
                </div>
                <i class="fas fa-calendar fa-2x opacity-50"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card @(Model.Condition == "جيدة" || Model.Condition == "ممتازة" ? "success" : "warning")">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">@Model.Condition</h5>
                    <small>الحالة</small>
                </div>
                <i class="fas fa-check-circle fa-2x opacity-50"></i>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Stock Info -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>معلومات المخزون
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th style="width: 40%;">المادة:</th>
                        <td>
                            <a asp-controller="Materials" asp-action="Details" asp-route-id="@Model.MaterialId">
                                @Model.Material.Name
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th>رمز المادة:</th>
                        <td><code>@Model.Material.Code</code></td>
                    </tr>
                    <tr>
                        <th>الفئة:</th>
                        <td>@(Model.Material.Category?.Name ?? "-")</td>
                    </tr>
                    <tr>
                        <th>الموقع:</th>
                        <td>
                            <a asp-controller="Locations" asp-action="Details" asp-route-id="@Model.LocationId">
                                @Model.Location.Name
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th>الموقع الدقيق:</th>
                        <td>@(Model.ExactLocation ?? "-")</td>
                    </tr>
                    <tr>
                        <th>رقم الدفعة:</th>
                        <td>@(Model.BatchNumber ?? "-")</td>
                    </tr>
                    <tr>
                        <th>الكمية المحجوزة:</th>
                        <td>@Model.ReservedQuantity</td>
                    </tr>
                    <tr>
                        <th>الكمية المتاحة:</th>
                        <td><strong>@Model.AvailableQuantity</strong></td>
                    </tr>
                    <tr>
                        <th>الحد الأدنى:</th>
                        <td>@Model.Material.MinimumStock</td>
                    </tr>
                    <tr>
                        <th>آخر تحديث:</th>
                        <td>@Model.LastUpdated.ToString("yyyy/MM/dd HH:mm")</td>
                    </tr>
                </table>

                @if (!string.IsNullOrEmpty(Model.Notes))
                {
                    <hr />
                    <h6>ملاحظات:</h6>
                    <p class="text-muted mb-0" style="white-space: pre-line;">@Model.Notes</p>
                }
            </div>
        </div>
    </div>

    <!-- Material Info & Recent Activity -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-box me-2"></i>معلومات المادة
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th style="width: 40%;">الوحدة:</th>
                        <td>@Model.Material.Unit</td>
                    </tr>
                    <tr>
                        <th>متوسط السعر:</th>
                        <td>@Model.Material.AveragePrice.ToString("N0") د.ع</td>
                    </tr>
                    <tr>
                        <th>آخر سعر شراء:</th>
                        <td>@((Model.Material.LastPurchasePrice ?? 0).ToString("N0")) د.ع</td>
                    </tr>
                    <tr>
                        <th>إجمالي الكمية (كل المواقع):</th>
                        <td>@Model.Material.TotalQuantity</td>
                    </tr>
                    <tr>
                        <th>القيمة الإجمالية:</th>
                        <td>@Model.Material.TotalValue.ToString("N0") د.ع</td>
                    </tr>
                </table>

                @if (!string.IsNullOrEmpty(Model.Material.Description))
                {
                    <hr />
                    <h6>وصف المادة:</h6>
                    <p class="text-muted mb-0">@Model.Material.Description</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- Recent Purchases -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-shopping-cart me-2"></i>آخر المشتريات لهذه المادة</span>
        <a asp-controller="Purchases" asp-action="Index" asp-route-materialId="@Model.MaterialId" 
           class="btn btn-sm btn-outline-primary">عرض الكل</a>
    </div>
    <div class="card-body p-0">
        @if (Model.Material.Purchases?.Any() == true)
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الكمية</th>
                            <th>سعر الوحدة</th>
                            <th>الإجمالي</th>
                            <th>المورد</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var purchase in Model.Material.Purchases.OrderByDescending(p => p.PurchaseDate).Take(5))
                        {
                            <tr>
                                <td>@purchase.PurchaseDate.ToString("yyyy/MM/dd")</td>
                                <td>@purchase.Quantity</td>
                                <td>@purchase.UnitPrice.ToString("N0")</td>
                                <td>@purchase.TotalPrice.ToString("N0")</td>
                                <td>@(purchase.Supplier ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-4 text-muted">
                لا توجد مشتريات مسجلة
            </div>
        }
    </div>
</div>

<!-- Transfers -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <i class="fas fa-arrow-down me-2"></i>آخر عمليات الاستلام (واردة)
            </div>
            <div class="card-body p-0">
                @if (ViewBag.TransfersIn?.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>من</th>
                                    <th>الكمية</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in ViewBag.TransfersIn)
                                {
                                    <tr>
                                        <td>@t.TransferDate.ToString("yyyy/MM/dd")</td>
                                        <td>@t.FromLocation.Name</td>
                                        <td><span class="text-success">+@t.Quantity</span></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-3 text-muted">لا توجد عمليات استلام</div>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-arrow-up me-2"></i>آخر عمليات الصرف (صادرة)
            </div>
            <div class="card-body p-0">
                @if (ViewBag.TransfersOut?.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>إلى</th>
                                    <th>الكمية</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in ViewBag.TransfersOut)
                                {
                                    <tr>
                                        <td>@t.TransferDate.ToString("yyyy/MM/dd")</td>
                                        <td>@t.ToLocation.Name</td>
                                        <td><span class="text-danger">-@t.Quantity</span></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-3 text-muted">لا توجد عمليات صرف</div>
                }
            </div>
        </div>
    </div>
</div>
