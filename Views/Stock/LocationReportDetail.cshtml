@model WarehouseManagement.Models.ViewModels.LocationReportViewModel
@{
    ViewData["Title"] = "تقرير الموقع - " + Model.Location?.Name;
}

<div class="container-fluid" dir="rtl">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/"><i class="bi bi-house"></i> الرئيسية</a></li>
            <li class="breadcrumb-item"><a href="/Stock">المخزون</a></li>
            <li class="breadcrumb-item"><a href="/Stock/LocationReport">تقارير المواقع</a></li>
            <li class="breadcrumb-item active">@Model.Location?.Name</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-geo-alt text-primary"></i> @Model.Location?.Name</h2>
            <p class="text-muted mb-0">
                <i class="bi bi-upc"></i> @Model.Location?.Code
                @if (!string.IsNullOrEmpty(Model.Location?.ResponsiblePerson))
                {
                    <span class="mx-2">|</span>
                    <i class="bi bi-person"></i> @Model.Location.ResponsiblePerson
                }
            </p>
        </div>
        <div class="btn-group">
            <a asp-controller="Reports" asp-action="ExportLocationReport" asp-route-id="@Model.Location?.Id" class="btn btn-success">
                <i class="bi bi-file-excel"></i> تصدير Excel
            </a>
            <button onclick="window.print()" class="btn btn-outline-secondary">
                <i class="bi bi-printer"></i> طباعة
            </button>
            <a asp-action="LocationReport" class="btn btn-outline-primary">
                <i class="bi bi-arrow-right"></i> كل المواقع
            </a>
        </div>
    </div>

    <!-- إحصائيات الموقع -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-boxes fs-1 mb-2"></i>
                    <h3>@Model.TotalItems</h3>
                    <p class="mb-0">عدد المواد</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="bi bi-stack fs-1 mb-2"></i>
                    <h3>@Model.TotalQuantity.ToString("N0")</h3>
                    <p class="mb-0">إجمالي الكميات</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="bi bi-currency-dollar fs-1 mb-2"></i>
                    <h3>@Model.TotalValue.ToString("N0")</h3>
                    <p class="mb-0">القيمة الإجمالية (د.ع)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle fs-1 mb-2"></i>
                    <h3>@(Model.Stocks?.Count(s => s.Quantity <= s.Material.MinimumStock) ?? 0)</h3>
                    <p class="mb-0">مخزون منخفض</p>
                </div>
            </div>
        </div>
    </div>

    <!-- معلومات الموقع -->
    @if (Model.Location != null)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> معلومات الموقع</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>الكود:</strong> @Model.Location.Code
                    </div>
                    <div class="col-md-3">
                        <strong>الاسم:</strong> @Model.Location.Name
                    </div>
                    <div class="col-md-3">
                        <strong>المسؤول:</strong> @(Model.Location.ResponsiblePerson ?? "-")
                    </div>
                    <div class="col-md-3">
                        <strong>الحالة:</strong>
                        <span class="badge @(Model.Location.IsActive ? "bg-success" : "bg-danger")">
                            @(Model.Location.IsActive ? "نشط" : "غير نشط")
                        </span>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Model.Location.Description))
                {
                    <div class="mt-2">
                        <strong>الوصف:</strong> @Model.Location.Description
                    </div>
                }
            </div>
        </div>
    }

    <!-- جدول المواد -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-table"></i> المواد في هذا الموقع</h5>
            <div>
                <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="بحث..." style="width: 200px;">
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="stocksTable">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>كود المادة</th>
                            <th>اسم المادة</th>
                            <th>التصنيف</th>
                            <th>الوحدة</th>
                            <th>الكمية</th>
                            <th>الحد الأدنى</th>
                            <th>سعر الوحدة</th>
                            <th>القيمة</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Stocks != null && Model.Stocks.Any())
                        {
                            int counter = 1;
                            foreach (var stock in Model.Stocks)
                            {
                                var isLowStock = stock.Quantity <= stock.Material.MinimumStock;
                                var isExpiring = stock.ExpiryDate.HasValue && stock.ExpiryDate <= DateTime.Now.AddDays(30);
                                var isExpired = stock.ExpiryDate.HasValue && stock.ExpiryDate < DateTime.Now;
                                
                                <tr class="@(isExpired ? "table-danger" : isLowStock ? "table-warning" : "")">
                                    <td>@counter</td>
                                    <td><code>@stock.Material.Code</code></td>
                                    <td>
                                        <a href="/Materials/Details/@stock.MaterialId">@stock.Material.Name</a>
                                    </td>
                                    <td>@(stock.Material.Category?.Name ?? "-")</td>
                                    <td>@stock.Material.Unit</td>
                                    <td>
                                        <strong class="@(isLowStock ? "text-danger" : "")">@stock.Quantity.ToString("N0")</strong>
                                    </td>
                                    <td>@stock.Material.MinimumStock</td>
                                    <td>@stock.Material.AveragePrice.ToString("N0")</td>
                                    <td>@stock.CurrentValue.ToString("N0")</td>
                                    <td>
                                        @if (isExpired)
                                        {
                                            <span class="badge bg-danger">منتهي الصلاحية</span>
                                        }
                                        else if (isExpiring)
                                        {
                                            <span class="badge bg-warning text-dark">قرب الانتهاء</span>
                                        }
                                        else if (isLowStock)
                                        {
                                            <span class="badge bg-warning text-dark">مخزون منخفض</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">جيد</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/Stock/Details/@stock.Id" class="btn btn-outline-primary" title="تفاصيل">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="/Stock/Adjust/@stock.Id" class="btn btn-outline-warning" title="تعديل">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="/Transfers/Create?materialId=@stock.MaterialId&fromLocationId=@stock.LocationId" class="btn btn-outline-info" title="نقل">
                                                <i class="bi bi-arrow-left-right"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                counter++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="11" class="text-center py-5">
                                    <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                                    <p class="text-muted mt-2">لا توجد مواد في هذا الموقع</p>
                                    <a href="/Stock/Create?locationId=@Model.Location?.Id" class="btn btn-primary">
                                        <i class="bi bi-plus-circle"></i> إضافة مخزون
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                    @if (Model.Stocks != null && Model.Stocks.Any())
                    {
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="5">الإجمالي</th>
                                <th>@Model.TotalQuantity.ToString("N0")</th>
                                <th colspan="2"></th>
                                <th>@Model.TotalValue.ToString("N0")</th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    }
                </table>
            </div>
        </div>
    </div>

    <!-- ملخص التصنيفات -->
    @if (Model.Stocks != null && Model.Stocks.Any())
    {
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> حسب التصنيف</h5>
                    </div>
                    <ul class="list-group list-group-flush">
                        @foreach (var group in Model.Stocks.GroupBy(s => s.Material.Category?.Name ?? "بدون تصنيف").OrderByDescending(g => g.Sum(s => s.CurrentValue)))
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>@group.Key</strong>
                                    <small class="text-muted d-block">@group.Count() مادة</small>
                                </div>
                                <div class="text-end">
                                    <strong>@group.Sum(s => s.CurrentValue).ToString("N0")</strong>
                                    <small class="text-muted d-block">د.ع</small>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> تنبيهات</h5>
                    </div>
                    <ul class="list-group list-group-flush">
                        @{
                            var lowStockItems = Model.Stocks.Where(s => s.Quantity <= s.Material.MinimumStock).ToList();
                            var expiringItems = Model.Stocks.Where(s => s.ExpiryDate.HasValue && s.ExpiryDate <= DateTime.Now.AddDays(30) && s.ExpiryDate > DateTime.Now).ToList();
                            var expiredItems = Model.Stocks.Where(s => s.ExpiryDate.HasValue && s.ExpiryDate < DateTime.Now).ToList();
                        }
                        
                        <li class="list-group-item d-flex justify-content-between align-items-center @(lowStockItems.Any() ? "list-group-item-warning" : "")">
                            <span><i class="bi bi-box-seam"></i> مخزون منخفض</span>
                            <span class="badge bg-warning text-dark">@lowStockItems.Count</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center @(expiringItems.Any() ? "list-group-item-info" : "")">
                            <span><i class="bi bi-clock"></i> قرب انتهاء الصلاحية</span>
                            <span class="badge bg-info">@expiringItems.Count</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center @(expiredItems.Any() ? "list-group-item-danger" : "")">
                            <span><i class="bi bi-x-circle"></i> منتهي الصلاحية</span>
                            <span class="badge bg-danger">@expiredItems.Count</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // بحث في الجدول
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('#stocksTable tbody tr');
            
            rows.forEach(function(row) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    </script>
}
